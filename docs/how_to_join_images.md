# How to Join Perseverance Images

## Metadata SQL Schema

Suppose the JSON image metadata from the Mars Perseverance RSS feed is stored in an SQLite database, using the following schema:

```sql
CREATE TABLE IF NOT EXISTS Images (
    image_id TEXT NOT NULL PRIMARY KEY,

    credit TEXT NOT NULL,
    caption TEXT NOT NULL,
    title TEXT NOT NULL,

    cam_instrument TEXT NOT NULL,
    cam_filter TEXT NOT NULL,
    cam_model_component_list TEXT NOT NULL,
    cam_model_type TEXT NOT NULL,
    cam_position TEXT NOT NULL,

    sample_type TEXT NOT NULL,

    full_res_url TEXT,
    json_url TEXT,

    date_taken_utc TIMESTAMP NOT NULL,
    -- Is attitude an optional quaternion?  It looks like a tuple.
    attitude TEXT NOT NULL,
    drive INTEGER,
    site INTEGER,

    -- extended properties:
    ext_mast_azimuth REAL,
    ext_mast_elevation REAL,
    ext_sclk REAL,
    ext_scale_factor REAL,

    -- position?  What are the coordinates?
    ext_x REAL,
    ext_y REAL,
    ext_z REAL,

    -- subframe rect seems to tell where each image (given scale factor = 1.0)
    -- belongs in a panorama.
    ext_sf_left REAL,
    ext_sf_top REAL,
    ext_sf_width REAL,
    ext_sf_height REAL,

    -- dimension: (width, height) -- actual img size in pixels
    ext_width REAL,
    ext_height REAL
);
```

Banging around with [ipython-sql](https://pypi.org/project/ipython-sql/), I think I have found that at least some panorama tiles for Navcams have been downloaded to the rover with identical `sclk` values.

For example, this query in a Jupyter notebook:

```sql
%%sql SELECT
site, drive, ext_sclk,
ext_sf_left x, ext_sf_top y,
ext_sf_width w, ext_sf_height h,
cam_position,
attitude,
ext_mast_azimuth az, ext_mast_elevation elev,
image_id
FROM Images
WHERE cam_instrument = 'NAVCAM_LEFT'
AND sample_type = 'Full'
AND ext_scale_factor = 1.0
ORDER BY site, drive, ext_sclk, x, y, image_id;
```

Produces this output fragment:

```
3	0	667755063.855	1.0	1.0	1288.0	968.0	(0.844971,0.311077,-1.86789)	(0.400487,-0.00394207,-0.00967878,0.916243)	336.761	-45.1065	NLE_0009_0667755063_497ECM_N0030000NCAM00102_01_0LLJ
3	0	667755063.855	1.0	953.0	1288.0	976.0	(0.844971,0.311077,-1.86789)	(0.400487,-0.00394207,-0.00967878,0.916243)	336.761	-45.1065	NLE_0009_0667755063_497ECM_N0030000NCAM00102_05_0LLJ
3	0	667755063.855	1.0	1913.0	1288.0	976.0	(0.844971,0.311077,-1.86789)	(0.400487,-0.00394207,-0.00967878,0.916243)	336.761	-45.1065	NLE_0009_0667755063_497ECM_N0030000NCAM00102_09_0LLJ
3	0	667755063.855	1.0	2873.0	1288.0	968.0	(0.844971,0.311077,-1.86789)	(0.400487,-0.00394207,-0.00967878,0.916243)	336.761	-45.1065	NLE_0009_0667755063_497ECM_N0030000NCAM00102_13_0LLJ
3	0	667755063.855	1273.0	1.0	1296.0	968.0	(0.844971,0.311077,-1.86789)	(0.400487,-0.00394207,-0.00967878,0.916243)	336.761	-45.1065	NLE_0009_0667755063_497ECM_N0030000NCAM00102_02_0LLJ
3	0	667755063.855	1273.0	953.0	1296.0	976.0	(0.844971,0.311077,-1.86789)	(0.400487,-0.00394207,-0.00967878,0.916243)	336.761	-45.1065	NLE_0009_0667755063_497ECM_N0030000NCAM00102_06_0LLJ
3	0	667755063.855	1273.0	1913.0	1296.0	976.0	(0.844971,0.311077,-1.86789)	(0.400487,-0.00394207,-0.00967878,0.916243)	336.761	-45.1065	NLE_0009_0667755063_497ECM_N0030000NCAM00102_10_0LLJ
3	0	667755063.855	1273.0	2873.0	1296.0	968.0	(0.844971,0.311077,-1.86789)	(0.400487,-0.00394207,-0.00967878,0.916243)	336.761	-45.1065	NLE_0009_0667755063_497ECM_N0030000NCAM00102_14_0LLJ
3	0	667755063.855	2553.0	1.0	1296.0	968.0	(0.844971,0.311077,-1.86789)	(0.400487,-0.00394207,-0.00967878,0.916243)	336.761	-45.1065	NLE_0009_0667755063_497ECM_N0030000NCAM00102_03_0LLJ
3	0	667755063.855	2553.0	953.0	1296.0	976.0	(0.844971,0.311077,-1.86789)	(0.400487,-0.00394207,-0.00967878,0.916243)	336.761	-45.1065	NLE_0009_0667755063_497ECM_N0030000NCAM00102_07_0LLJ
3	0	667755063.855	2553.0	1913.0	1296.0	976.0	(0.844971,0.311077,-1.86789)	(0.400487,-0.00394207,-0.00967878,0.916243)	336.761	-45.1065	NLE_0009_0667755063_497ECM_N0030000NCAM00102_11_0LLJ
3	0	667755063.855	2553.0	2873.0	1296.0	968.0	(0.844971,0.311077,-1.86789)	(0.400487,-0.00394207,-0.00967878,0.916243)	336.761	-45.1065	NLE_0009_0667755063_497ECM_N0030000NCAM00102_15_0LLJ
3	0	667755063.855	3833.0	1.0	1288.0	968.0	(0.844971,0.311077,-1.86789)	(0.400487,-0.00394207,-0.00967878,0.916243)	336.761	-45.1065	NLE_0009_0667755063_497ECM_N0030000NCAM00102_04_0LLJ
3	0	667755063.855	3833.0	953.0	1288.0	976.0	(0.844971,0.311077,-1.86789)	(0.400487,-0.00394207,-0.00967878,0.916243)	336.761	-45.1065	NLE_0009_0667755063_497ECM_N0030000NCAM00102_08_0LLJ
3	0	667755063.855	3833.0	1913.0	1288.0	976.0	(0.844971,0.311077,-1.86789)	(0.400487,-0.00394207,-0.00967878,0.916243)	336.761	-45.1065	NLE_0009_0667755063_497ECM_N0030000NCAM00102_12_0LLJ
3	0	667755063.855	3833.0	2873.0	1288.0	968.0	(0.844971,0.311077,-1.86789)	(0.400487,-0.00394207,-0.00967878,0.916243)	336.761	-45.1065	NLE_0009_0667755063_497ECM_N0030000NCAM00102_16_0LLJ
3	0	667755358.367	1.0	1.0	1288.0	968.0	(0.576434,0.658766,-1.85731)	(0.400487,-0.00394207,-0.00967878,0.916243)	214.991	-49.6908	NLE_0009_0667755357_850ECM_N0030000NCAM00103_01_0LLJ
3	0	667755358.367	1.0	953.0	1288.0	976.0	(0.576434,0.658766,-1.85731)	(0.400487,-0.00394207,-0.00967878,0.916243)	214.991	-49.6908	NLE_0009_0667755357_850ECM_N0030000NCAM00103_05_0LLJ
3	0	667755358.367	1273.0	1.0	1296.0	968.0	(0.576434,0.658766,-1.85731)	(0.400487,-0.00394207,-0.00967878,0.916243)	214.991	-49.6908	NLE_0009_0667755357_850ECM_N0030000NCAM00103_02_0LLJ
3	0	667755358.367	2553.0	1.0	1296.0	968.0	(0.576434,0.658766,-1.85731)	(0.400487,-0.00394207,-0.00967878,0.916243)	214.991	-49.6908	NLE_0009_0667755357_850ECM_N0030000NCAM00103_03_0LLJ
3	0	667755358.367	3833.0	1.0	1288.0	968.0	(0.576434,0.658766,-1.85731)	(0.400487,-0.00394207,-0.00967878,0.916243)	214.991	-49.6908	NLE_0009_0667755357_850ECM_N0030000NCAM00103_04_0LLJ
```

In addition to having identical `sclk` values, the mast azimuth and elevation appear to be constant for all tiles of a panorama.

All of these images are 'E' images.  That is, as Emily Lakdawalla has explained, they are the full sensor raw readout, and they need to be demosaic'ed.

I'll treat that as a separate exercise.  The immediate question is, can panorama tile constituent images be deduced somewhat reliably from `(sclk, cam_instrument)`?

The relevant experimental code is in this repo: `tools/band_finder/examples/find_navcam_panos.py`, and in particular in the `PanoFinder.gen_image_sets()` method:

```python
    def gen_image_sets(self):
        prev_sclk = None
        curr_set = []
        for record in self._gen_left_navcam_images():
            sclk = record["ext_sclk"]
            if sclk != prev_sclk:
                if curr_set:
                    yield curr_set
                curr_set = []
                prev_sclk = sclk
            else:
                curr_set.append(record)
        if curr_set:
            yield curr_set
```

I think it works.

```bash
$ python find_navcam_panos.py
[3, 0, 667755063.855, 1273.0, 1.0, 1296.0, 968.0, 'NLE_0009_0667755063_497ECM_N0030000NCAM00102_02_0LLJ']
[3, 0, 667755063.855, 2553.0, 1.0, 1296.0, 968.0, 'NLE_0009_0667755063_497ECM_N0030000NCAM00102_03_0LLJ']
[3, 0, 667755063.855, 3833.0, 1.0, 1288.0, 968.0, 'NLE_0009_0667755063_497ECM_N0030000NCAM00102_04_0LLJ']
[3, 0, 667755063.855, 1.0, 953.0, 1288.0, 976.0, 'NLE_0009_0667755063_497ECM_N0030000NCAM00102_05_0LLJ']
[3, 0, 667755063.855, 1273.0, 953.0, 1296.0, 976.0, 'NLE_0009_0667755063_497ECM_N0030000NCAM00102_06_0LLJ']
[3, 0, 667755063.855, 2553.0, 953.0, 1296.0, 976.0, 'NLE_0009_0667755063_497ECM_N0030000NCAM00102_07_0LLJ']
[3, 0, 667755063.855, 3833.0, 953.0, 1288.0, 976.0, 'NLE_0009_0667755063_497ECM_N0030000NCAM00102_08_0LLJ']
[3, 0, 667755063.855, 1.0, 1913.0, 1288.0, 976.0, 'NLE_0009_0667755063_497ECM_N0030000NCAM00102_09_0LLJ']
[3, 0, 667755063.855, 1273.0, 1913.0, 1296.0, 976.0, 'NLE_0009_0667755063_497ECM_N0030000NCAM00102_10_0LLJ']
[3, 0, 667755063.855, 2553.0, 1913.0, 1296.0, 976.0, 'NLE_0009_0667755063_497ECM_N0030000NCAM00102_11_0LLJ']
[3, 0, 667755063.855, 3833.0, 1913.0, 1288.0, 976.0, 'NLE_0009_0667755063_497ECM_N0030000NCAM00102_12_0LLJ']
[3, 0, 667755063.855, 1.0, 2873.0, 1288.0, 968.0, 'NLE_0009_0667755063_497ECM_N0030000NCAM00102_13_0LLJ']
[3, 0, 667755063.855, 1273.0, 2873.0, 1296.0, 968.0, 'NLE_0009_0667755063_497ECM_N0030000NCAM00102_14_0LLJ']
[3, 0, 667755063.855, 2553.0, 2873.0, 1296.0, 968.0, 'NLE_0009_0667755063_497ECM_N0030000NCAM00102_15_0LLJ']
[3, 0, 667755063.855, 3833.0, 2873.0, 1288.0, 968.0, 'NLE_0009_0667755063_497ECM_N0030000NCAM00102_16_0LLJ']

[3, 0, 667755358.367, 1273.0, 1.0, 1296.0, 968.0, 'NLE_0009_0667755357_850ECM_N0030000NCAM00103_02_0LLJ']
[3, 0, 667755358.367, 2553.0, 1.0, 1296.0, 968.0, 'NLE_0009_0667755357_850ECM_N0030000NCAM00103_03_0LLJ']
[3, 0, 667755358.367, 3833.0, 1.0, 1288.0, 968.0, 'NLE_0009_0667755357_850ECM_N0030000NCAM00103_04_0LLJ']
[3, 0, 667755358.367, 1.0, 953.0, 1288.0, 976.0, 'NLE_0009_0667755357_850ECM_N0030000NCAM00103_05_0LLJ']
```